dist: xenial
sudo: required
language: c

branches:
  only:
  - v8.8
  - v8.9
  - v8.9+worker
  - v8.10
  - v8.11

cache:
  apt: true
  directories:
  - $HOME/.opam
addons:
  apt:
    packages:
    - gcc-multilib
env:
  global:
  - NJOBS="2"
  - OPAMROOTISOK="true"
  - OPAMYES="true"
  - OPAMJOBS="2"
  - JSCOQ_ARCH="32"

matrix:
  include:
    - dist: xenial
    - os: osx
      cache:
        ccache: true
        directories:
          - $HOME/.opam
          - $HOME/Library/Caches/Homebrew
      before_cache:
        - brew cleanup
      env:
        - JSCOQ_ARCH="64"
      before_install: |
        set -e
        brew update
        brew install ccache opam

before_install: |
  sudo curl -sL https://github.com/ocaml/opam/releases/download/2.0.4/opam-2.0.4-x86_64-linux -o /usr/bin/opam
  sudo chmod 755 /usr/bin/opam

install:
- opam init -y --bare --disable-sandboxing || true
- eval $(opam env)
- ./etc/toolchain-setup.sh --"$JSCOQ_ARCH"
- eval $(opam env)
- opam switch
- opam list
- opam config var root
- git submodule update --remote

script:
- set -e
- echo 'Building Coq...' && echo -en 'travis_fold:start:coq.build\\r'
- make coq-get
- echo -en 'travis_fold:end:coq.build\\r'
- echo 'Building JsCoq...' && echo -en 'travis_fold:start:jscoq.build\\r'
- make jscoq
- make libs-pkg
- echo -en 'travis_fold:end:jscoq.build\\r'
- echo 'Building Addons...' && echo -en 'travis_fold:start:addons.build\\r'
- make addons
- make jscoq
- make libs-pkg
- echo -en 'travis_fold:end:addons.build\\r'
