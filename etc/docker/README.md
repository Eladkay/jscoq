# jsCoq Docker build

The Dockerfile and accompanying Makefile in this directory can be used for
reproducible builds of jsCoq and the so-called "affiliated" addons
(the ones in https://github.com/jscoq/addons).

The build procedure is split into several phases.

|         |                                                             |
|---------|-------------------------------------------------------------|
| jscoq:preinstall | Prepares a base container with required packages from `apt`, a suitable version of OPAM, and an OPAM switch named `jscoq+32bit`. |
| jscoq:prereq | Clones the jsCoq repository and runs `etc/toolchain-setup.sh`. |
| jscoq        | Builds jsCoq and prepares distribution tarballs.               |
| jscoq:addons | Clones the addons repository and builds them against the exact version of jsCoq from the previous phase; builds NPM packages for these addons.  |
| jscoq:sdk    | (WIP) Builds a Docker image with Coq binaries suitable for building user addons on top of jsCoq.  |

The above are built with the JavaScript backend. For the WebAssembly backend,
there are analogous phases with a "wacoq" prefix
(except for wacoq:sdk, which not available yet).

Each build phase generates a tagged Docker image as described in "Building",
below.

*Note.* By default, only publicly available packages are built during the jscoq:addons phase.
To build private repositories (currently, only [sfdev](https://github.com/DeepSpec/sfdev)), create a directory named `_ssh` and copy your SSH keys (usually stored in `~/.ssh`) into it.

## Building

To run the build, you only need the contents of this subdirectory (`etc/docker`).
All other sources and dependencies are cloned or fetched from remote package repositories.
The `Makefile` is used to run `docker build` and set required flags and arguments. It uses BuildKit to select the appropriate build phases.
To run the complete staged build:
```
make
```

The default target builds the JavaScript variant.
To build waCoq, run
```
make wa-build
```

The images are tagged and stored in your Docker. To remove old builds, run `make clean` or `make clean-slate` (the former keeps opam and jscoq:prereq, whereas the latter purges them as well).
Take notice that these also run `docker system prune -f` to clean up any dangling containers and remove cache entries.

To extract the built tarballs from the Docker container:
```
make dist
```

This creates a subdirectory `dist/` and copies the tarballs generated by the jscoq, jscoq:addons, wacoq, and wacoq:addons phases.

To extract only JS or only WA distribution files, use `make js-dist` or
`make wa-dist`.
